<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beats | Modern Music Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5344540996924865"
     crossorigin="anonymous"></script>
    <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "roypltgso5");
    </script>
    <!-- Hotjar Tracking Code for Site 6414717 -->
    <script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:6414717,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
    </script>
    <script src="https://cdn.counter.dev/script.js" data-id="67e72549-d0dc-4b8f-9f74-a6a15294bd10" data-utcoffset="6"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-T708H6GXQ4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-T708H6GXQ4');
    </script>
    <script data-goatcounter="https://765211.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <script defer src="https://cloud.umami.is/script.js" data-website-id="6b55dbb3-7233-46e9-8705-cd9403ffcef2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@200;300;400;500;600;700;800;900;1000&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #7b68ee;
            --secondary: #800080;
            --dark: #666699;
            --card-bg: #282828;
            --text: #f4f0ec;
            --text-highlight: #e5e4e2;
            --gradient: linear-gradient(90deg, #8c52ff, #8c52ff);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        /* TRANSPARENT SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(123, 104, 238, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(123, 104, 238, 0.5);
        }

        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(123, 104, 238, 0.3) transparent;
        }

        body {
            background-image: url('https://images.pexels.com/photos/4737484/pexels-photo-4737484.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
            color: var(--text);
            min-height: 100vh;
            display: flex;
        }

        .container {
            flex: 1;
            padding: 20px;
            margin-left: 230px;
            display: block;
        }

        .main-content {
            overflow-y: auto;
            max-height: calc(100vh - 140px);
            margin-bottom: 100px; /* Prevent content going under player */
            padding-bottom: 20px;
        }

        .sidebar {
            width: 200px;
            height: fit-content;
            padding: 10px;
            margin: 130px 0 0 20px;
            background-color: rgba(0, 0, 0, 0.07);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-self: flex-start;
            position: fixed;
            z-index: 10;
        }

        .tab {
            list-style: none;
            color: white;
            font-weight: bold;
            padding: 10px 14px;
            margin: 0;
            position: relative;
            cursor: pointer;
            white-space: nowrap;
            border-radius: 25px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            z-index: 2;
        }

        .tab i {
            margin-right: 10px;
        }

        .tab::before {
            content: " ";
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            z-index: -1;
            transition: 0.2s;
            border-radius: 25px;
        }

        .tab:hover {
            color: black;
        }

        .tab:hover::before {
            background: linear-gradient(to bottom, #e8edec, #d2d1d3);
            box-shadow: 0px 3px 20px 0px black;
            transform: scale(1.2);
        }

        .tab.active {
            color: black;
        }

        .tab.active::before {
            background: linear-gradient(to bottom, #e8edec, #d2d1d3);
            box-shadow: 0px 3px 20px 0px black;
            transform: scale(1.1);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 30px;
            background-color: rgba(0, 0, 0, 0);
            border-radius: 20px;
        }

        .logo {
            font-size: 30px;
            font-weight: 700;
            color: #FAF7F7;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 5px;
        }

        .search-bar {
            flex: 0.5;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: none;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-highlight);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
        }

        .search-bar input::placeholder {
            color: var(--text);
        }

        .search-bar i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text);
        }

        .user-actions button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-highlight);
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 15px;
            transition: all 0.3s ease;
        }

        .user-actions button:hover {
            background: #c41e3a;
            transform: scale(1.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .music-card {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .music-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            background: linear-gradient(135deg, rgba(83, 83, 247, 0.2), rgba(29, 185, 84, 0.2));
        }

        .music-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 12px 12px 0 0;
        }

        .music-info {
            padding: 12px;
        }

        .music-info h3 {
            font-size: 14px;
            color: var(--text-highlight);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-info p {
            font-size: 12px;
            color: var(--text);
        }

        .music-card .add-to-playlist {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: var(--text-highlight);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .music-card:hover .add-to-playlist {
            opacity: 1;
        }

        .player-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.07);
            backdrop-filter: blur(10px);
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.5);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            z-index: 100;
            border-radius: 20px 20px 0 0;
            height: 90px; /* Fixed height */
            min-height: 90px;
            max-height: 90px;
            overflow: hidden;
        }

        .player-album-art {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 20px;
            flex-shrink: 0; /* Don't shrink */
        }

        .player-info {
            flex: 0 0 200px; /* Fixed width */
            min-width: 0; /* Allow text truncation */
            overflow: hidden;
        }

        .player-info h4 {
            font-size: 14px;
            color: var(--text-highlight);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .player-info p {
            font-size: 12px;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .player-controls {
            display: flex;
            align-items: center;
            flex: 0 0 300px; /* Fixed width */
            justify-content: center;
        }

        .player-controls button {
            background: none;
            border: none;
            font-size: 18px;
            margin: 0 15px;
            cursor: pointer;
            color: var(--text);
            transition: all 0.3s ease;
        }

        .player-controls button:hover {
            color: var(--text-highlight);
            transform: scale(1.1);
        }

        .player-controls .play-btn {
            font-size: 24px;
            background: var(--primary);
            color: var(--text-highlight);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(29, 185, 84, 0.4);
        }

        .player-controls .play-btn:hover {
            background: #c41e3a;
            transform: scale(1.05);
        }

        .player-progress {
            flex: 3;
            display: flex;
            align-items: center;
            position: relative;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 0 15px;
            cursor: pointer;
            position: relative;
        }

        .progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: #c41e3a;
            border-radius: 2px;
            transition: width 0.2s ease;
        }

        .time {
            font-size: 12px;
            color: var(--text);
            min-width: 35px;
        }

        /* VOLUME VISUALIZER - EXACT SAME WIDTH AS PROGRESS BAR */
        .volume-visualizer {
            position: absolute;
            top: -20px;
            left: 0;
            right: 0;
            height: 20px;
            display: flex;
            align-items: end;
            justify-content: center;
            gap: 1px;
            pointer-events: none;
        }

        .volume-bar {
            width: 2px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1px;
            transition: all 0.1s ease;
        }

        .volume-bar.active {
            background: linear-gradient(to top, #c41e3a, var(--primary));
        }

        .player-actions {
            display: flex;
            align-items: center;
        }

        .player-actions button {
            background: none;
            border: none;
            font-size: 16px;
            margin-left: 15px;
            cursor: pointer;
            color: var(--text);
            transition: all 0.3s ease;
        }

        .player-actions button:hover {
            color: var(--text-highlight);
        }

        .player-actions .liked {
            color: #c41e3a;
        }

        .volume-control {
            display: flex;
            width: 100px;
            align-items: center;
            margin-left: 20px;
        }

        .volume-control input {
            width: 100px;
            margin-left: 10px;
            accent-color: #c41e3a;
        }

        .lyrics-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background-color: rgba(0, 0, 0, 0.01);
            backdrop-filter: blur(1px);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 120px; /* Prevent going under player */
        }

        .lyrics-loading, .lyrics-error {
            color: var(--text);
            font-size: 16px;
            margin-bottom: 20px;
        }

        .lyrics-error {
            color: #e74c3c;
        }

        .lyrics-line {
            font-size: 18px;
            color: var(--text);
            margin: 8px 0;
            transition: all 0.3s ease;
        }

        .lyrics-line.active {
            color: var(--text-highlight);
            font-weight: 700;
            background: var(--gradient);
            padding: 8px 16px;
            border-radius: 20px;
        }

        .type-lyrics-btn, .save-lyrics-btn {
            background: var(--primary);
            color: var(--text-highlight);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .type-lyrics-btn:hover, .save-lyrics-btn:hover {
            background: #c41e3a;
            transform: scale(1.05);
        }

        .lyrics-input-container {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
        }

        .lyrics-input-container.active {
            display: flex;
        }

        .lyrics-input {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-highlight);
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .lyrics-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
        }

        /* NEW HOME PAGE STYLES */
        .home-content {
            font-family: 'Nunito', sans-serif;
        }

        .home-section {
            margin-bottom: 40px;
        }

        .home-section h2 {
            color: #fff;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        /* TRENDING SONGS - HORIZONTAL SCROLL WITH SCROLLBAR */
        .trending-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 20px 0 30px 0; /* Extra bottom padding for scrollbar */
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: rgba(123, 104, 238, 0.5) rgba(255, 255, 255, 0.1);
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            white-space: nowrap;
        }
        .trending-container::-webkit-scrollbar {
            height: 8px;
            display: block;
        }
        .trending-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 0 10px;
        }
        .trending-container::-webkit-scrollbar-thumb {
            background: rgba(123, 104, 238, 0.5);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        .trending-container::-webkit-scrollbar-thumb:hover {
            background: rgba(123, 104, 238, 0.8);
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .trending-song {
            min-width: 200px; /* Fixed width to ensure scrolling */
            max-width: 200px; /* Make sure all cards are same width */
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .trending-song:hover {
            transform: translateY(-8px) scale(1.05);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border-color: var(--primary);
        }

        .trending-song img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .trending-song:hover img {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        .trending-song .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(196, 30, 58, 0.9);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 18px;
            box-shadow: 0 5px 15px rgba(196, 30, 58, 0.4);
        }

        .trending-song:hover .play-icon {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* Featured Artists */
        .featured-artists {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 40px;
            scrollbar-width: thin;
            scrollbar-color: rgba(123, 104, 238, 0.5) rgba(255, 255, 255, 0.1);
        }

        .featured-artists::-webkit-scrollbar {
            height: 8px;
            display: block;
        }

        .featured-artists::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .featured-artists::-webkit-scrollbar-thumb {
            background: rgba(123, 104, 238, 0.5);
            border-radius: 10px;
        }

        .featured-artists::-webkit-scrollbar-thumb:hover {
            background: rgba(123, 104, 238, 0.8);
        }

        .artist-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .artist-card:hover {
            transform: translateY(-5px);
        }

        .artist-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .artist-card:hover .artist-avatar {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(123, 104, 238, 0.5);
        }

        .artist-name {
            color: #fff;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }

        /* Recent Albums */
        .recent-albums {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }

        .album-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .album-card:hover {
            transform: translateY(-5px);
        }

        .album-cover {
            width: 100%;
            height: 150px;
            border-radius: 12px;
            object-fit: cover;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .album-card:hover .album-cover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .album-info h4 {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .album-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Recently Played */
        .recently-played {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .recent-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recent-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .recent-item img {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 15px;
        }

        .recent-info h4 {
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 3px;
        }

        .recent-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        .delete-btn {
            margin-left: auto;
            background: rgba(255, 0, 0, 0.2);
            border: none;
            color: #ff6b6b;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: rgba(255, 0, 0, 0.4);
        }

        /* Filter indicator */
        .filter-indicator {
            display: inline-block;
            background: rgba(123, 104, 238, 0.2);
            color: var(--text-highlight);
            padding: 5px 15px;
            border-radius: 20px;
            margin-bottom: 15px;
            font-size: 14px;
            font-weight: 500;
            animation: fadeIn 0.3s ease;
        }

        .filter-indicator i {
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-indicator i:hover {
            color: #c41e3a;
        }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .container { 
                margin-left: 0; 
                padding: 10px;
            }
            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                padding: 10px;
                margin: 10px 0;
                position: static;
                border-radius: 0;
                backdrop-filter: none;
                background: rgba(0, 0, 0, 0.2);
            }
            .tab { flex: 1; min-width: 100px; margin: 5px; }
            header { flex-direction: column; align-items: flex-start; }
            .search-bar { width: 100%; margin: 15px 0; }
            .user-actions { width: 100%; justify-content: flex-end; }
            .music-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
            .player-container { flex-wrap: wrap; padding: 10px; }
            .player-info { order: 1; flex: 1 0 100%; margin-bottom: 10px; }
            .player-controls { order: 2; flex: 1; justify-content: flex-start; }
            .player-progress { order: 4; flex: 1 0 100%; margin-top: 10px; }
            .player-actions { order: 3; flex: 1; justify-content: flex-end; }
            .lyrics-container { min-height: 200px; font-size: 14px; }
            .lyrics-input { font-size: 12px; height: 150px; }
            .featured-artists { gap: 15px; }
            .recent-albums { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
            .trending-container { gap: 15px; }
            .trending-song { min-width: 160px; }
        }

        .youtube-player { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-crown"></i>
                <span>Beats</span>
            </div>
            
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="search" placeholder="Search for songs, artists, or albums...">
            </div>
            
            <div class="user-actions">
                <input type="file" id="folderInput" webkitdirectory directory multiple accept="audio/mpeg,audio/wav,audio/ogg,audio/mp4" style="display: none;">
                <button id="upload-btn" onclick="selectDirectory()">
                    <i class="fas fa-plus"></i> Add Music
                </button>
            </div>
        </header>
        
        <div class="main-content">
            <!-- HOME TAB WITH NEW UI -->
            <div class="tab-content active" id="home-tab">
                <div class="home-content">
                    <!-- Trending Songs - Horizontal Scroll -->
                    <div class="home-section">
                        <h2>Trending Music</h2>
                        <div class="trending-container" id="trending-container">
                            <!-- Trending songs will be loaded here -->
                        </div>
                    </div>

                    <!-- Featured Artists -->
                    <div class="home-section">
                        <h2>Featured Artists</h2>
                        <div class="featured-artists" id="featured-artists">
                            <!-- Recent artists will be loaded here -->
                        </div>
                    </div>

                    <!-- Recent Albums -->
                    <div class="home-section">
                        <h2>Recent Albums</h2>
                        <div class="recent-albums" id="recent-albums">
                            <!-- Recent albums will be loaded here -->
                        </div>
                    </div>

                    <!-- Recently Played -->
                    <div class="home-section">
                        <h2>Recently Played</h2>
                        <div class="recently-played" id="recently-played">
                            <!-- History will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- OTHER EXISTING TABS -->
            <div class="tab-content" id="songs-tab">
                <div id="filter-indicator" style="display: none;" class="filter-indicator">
                    Showing: <span id="filter-text">All Songs</span>
                    <i class="fas fa-times" id="clear-filter"></i>
                </div>
                <div id="loading" style="display: none; color: var(--text); margin-bottom: 20px;">Loading files...</div>
                <div id="error" style="display: none; color: #e74c3c; margin-bottom: 20px;"></div>
                <div class="music-grid" id="songList"></div>
            </div>
            
            <div class="tab-content" id="artists-tab">
                <div class="music-grid" id="artistList"></div>
            </div>
            
            <div class="tab-content" id="albums-tab">
                <div class="music-grid" id="albumList"></div>
            </div>
            
            <div class="tab-content" id="playlists-tab">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <input
                        type="text"
                        id="playlistName"
                        placeholder="New playlist name..."
                        style="padding: 10px; border-radius: 20px; border: none; background: rgba(255, 255, 255, 0.1); color:#f4f0ec; width: 70%;"
                    >
                    <button
                        onclick="createPlaylist()"
                        style="background: var(--primary); color: var(--text-highlight); border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer;"
                    >
                        Create
                    </button>
                </div>
                <div class="music-grid" id="playlistList"></div>
            </div>
            
            <div class="tab-content" id="favorites-tab">
                <div class="music-grid" id="favoritesList"></div>
            </div>
            
            <div class="tab-content" id="online-tab">
                <div class="search-bar" style="margin-bottom: 20px;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="onlineSearch" placeholder="Search for songs on JioSaavn...">
                </div>
                <div id="onlineLoading" style="display: none; color: var(--text); margin-bottom: 20px;">Searching...</div>
                <div id="onlineError" style="display: none; color: #e74c3c; margin-bottom: 20px;"></div>
                <div class="music-grid" id="onlineList"></div>
            </div>
            
            <div class="tab-content" id="lyrics-tab">
                <div class="lyrics-container">
                    <button class="type-lyrics-btn" id="typeLyricsBtn">Type Lyrics</button>
                    <div class="lyrics-input-container" id="lyricsInputContainer">
                        <textarea class="lyrics-input" id="lyricsInput" placeholder="Type your lyrics here..."></textarea>
                        <button class="save-lyrics-btn" id="saveLyricsBtn">Save</button>
                    </div>
                    <div id="lyricsLoading" class="lyrics-loading">Loading lyrics...</div>
                    <div id="lyricsError" style="display: none;" class="lyrics-error"></div>
                    <div id="lyrics"></div>
                </div>
            </div>
            
            <div class="tab-content" id="history-tab">
                <div class="music-grid" id="historyList"></div>
            </div>
        </div>
    </div>
    
    <div class="sidebar">
        <div class="tab active" data-tab="home"><i class="fas fa-home"></i> Home</div>
        <div class="tab" data-tab="songs"><i class="fas fa-music"></i> All Songs</div>
        <div class="tab" data-tab="artists"><i class="fas fa-user"></i> Artists</div>
        <div class="tab" data-tab="albums"><i class="fas fa-compact-disc"></i> Albums</div>
        <div class="tab" data-tab="playlists"><i class="fas fa-list"></i> Playlists</div>
        <div class="tab" data-tab="favorites"><i class="fas fa-heart"></i> Favorites</div>
        <div class="tab" data-tab="online"><i class="fas fa-globe"></i> Online Search</div>
        <div class="tab" data-tab="lyrics"><i class="fas fa-align-left"></i> Lyrics</div>
        <div class="tab" data-tab="history"><i class="fas fa-history"></i> History</div>
    </div>
    
    <div class="player-container">
        <img src="/placeholder.svg" alt="Now Playing" class="player-album-art" id="playerAlbumArt">
        
        <div class="player-info">
            <h4 id="playerTitle">No song playing</h4>
            <p id="playerArtist">Select a song to play</p>
        </div>
        
        <div class="player-controls">
            <button id="shuffle-btn" title="Shuffle">
                <i class="fas fa-random"></i>
            </button>
            <button id="prev-btn" title="Previous">
                <i class="fas fa-step-backward"></i>
            </button>
            <button class="play-btn" id="play-btn" title="Play">
                <i class="fas fa-play"></i>
            </button>
            <button id="next-btn" title="Next">
                <i class="fas fa-step-forward"></i>
            </button>
            <button id="repeat-btn" title="Repeat">
                <i class="fas fa-redo"></i>
            </button>
        </div>
        
        <div class="player-progress">
            <span class="time" id="currentTime">0:00</span>
            <div class="progress-bar" id="progressBar">
                <div class="progress" id="progress"></div>
                <div class="volume-visualizer" id="volumeVisualizer">
                    <!-- Volume bars will be generated here -->
                </div>
            </div>
            <span class="time" id="duration">0:00</span>
        </div>
        
        <div class="player-actions">
            <button id="like-btn" title="Like">
                <i class="far fa-heart"></i>
            </button>
            <div class="volume-control">
                <i class="fas fa-volume-up"></i>
                <input type="range" min="0" max="100" value="100" id="volume-slider">
            </div>
        </div>
        
        <iframe id="youtube-player" class="youtube-player" src="/placeholder.svg" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    </div>
    
    <audio id="audio-player"></audio>
    
    <script>
        // GLOBAL VARIABLES
        const audioPlayer = document.getElementById('audio-player');
        const youtubePlayer = document.getElementById('youtube-player');
        const playBtn = document.getElementById('play-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const volumeVisualizer = document.getElementById('volumeVisualizer');
        const volumeSlider = document.getElementById('volume-slider');
        const playerTitle = document.getElementById('playerTitle');
        const playerArtist = document.getElementById('playerArtist');
        const playerAlbumArt = document.getElementById('playerAlbumArt');
        const search = document.getElementById('search');
        const folderInput = document.getElementById('folderInput');
        const songList = document.getElementById('songList');
        const artistList = document.getElementById('artistList');
        const albumList = document.getElementById('albumList');
        const playlistList = document.getElementById('playlistList');
        const favoritesList = document.getElementById('favoritesList');
        const lyrics = document.getElementById('lyrics');
        const lyricsLoading = document.getElementById('lyricsLoading');
        const lyricsError = document.getElementById('lyricsError');
        const likeBtn = document.getElementById('like-btn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const typeLyricsBtn = document.getElementById('typeLyricsBtn');
        const lyricsInputContainer = document.getElementById('lyricsInputContainer');
        const lyricsInput = document.getElementById('lyricsInput');
        const saveLyricsBtn = document.getElementById('saveLyricsBtn');
        const onlineSearch = document.getElementById('onlineSearch');
        const onlineList = document.getElementById('onlineList');
        const onlineLoading = document.getElementById('onlineLoading');
        const onlineError = document.getElementById('onlineError');
        const historyList = document.getElementById('historyList');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const filterIndicator = document.getElementById('filter-indicator');
        const filterText = document.getElementById('filter-text');
        const clearFilter = document.getElementById('clear-filter');

        let songs = [];
        let onlineSongs = [];
        let currentSongIndex = -1;
        let currentOnlinePlaylist = [];
        let currentOnlineSongIndex = -1;
        let isShuffling = false;
        let isRepeating = false;
        let playlists = [];
        let favorites = [];
        let currentLyrics = [];
        let isPlaying = false;
        let isOnlineSong = false;
        let currentVideoId = null;
        let history = JSON.parse(localStorage.getItem('musicAppHistory') || '[]');
        let trendingSongs = [];
        let lastTrendingUpdate = localStorage.getItem('lastTrendingUpdate') || 0;
        let recentArtists = JSON.parse(localStorage.getItem('recentArtists') || '[]');
        let recentAlbums = JSON.parse(localStorage.getItem('recentAlbums') || '[]');
        let activeFilter = ''; // Store active filter
        let isAlbumOnline = false; // Flag to track if album is from online search

        // GLOBAL FUNCTIONS - Make them accessible from HTML onclick
        window.playTrendingSong = playTrendingSong;
        window.removeFromHistory = removeFromHistory;
        window.selectDirectory = selectDirectory;
        window.createPlaylist = createPlaylist;
        window.addToPlaylistPrompt = addToPlaylistPrompt;
        window.addOnlineToPlaylistPrompt = addOnlineToPlaylistPrompt;
        window.deletePlaylist = deletePlaylist;

        // Initialize volume visualizer
        function initVolumeVisualizer() {
            volumeVisualizer.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const bar = document.createElement('div');
                bar.className = 'volume-bar';
                bar.style.height = Math.random() * 15 + 3 + 'px';
                volumeVisualizer.appendChild(bar);
            }
        }

        // Animate volume visualizer
        function animateVolumeVisualizer() {
            if (!isPlaying) return;
            
            const bars = volumeVisualizer.querySelectorAll('.volume-bar');
            bars.forEach((bar, index) => {
                const height = Math.random() * 15 + 3;
                const isActive = Math.random() > 0.4;
                bar.style.height = height + 'px';
                bar.classList.toggle('active', isActive);
            });
        }

        // Initialize everything
        initVolumeVisualizer();
        setInterval(animateVolumeVisualizer, 150);

        // Clear active filter
        clearFilter.addEventListener('click', () => {
            activeFilter = '';
            filterIndicator.style.display = 'none';
            updateSongList('');
            search.value = '';
        });

        // Load trending songs
        function loadTrendingSongs() {
            console.log('Loading trending songs...');
            const now = Date.now();
            const threeHours = 3 * 60 * 60 * 1000;
            
            if (now - lastTrendingUpdate > threeHours) {
                fetchTrendingSongs();
            } else {
                const savedTrending = localStorage.getItem('trendingSongs');
                if (savedTrending) {
                    trendingSongs = JSON.parse(savedTrending);
                    console.log('Loaded saved trending songs:', trendingSongs.length);
                    renderTrendingSongs();
                } else {
                    fetchTrendingSongs();
                }
            }
        }

        async function fetchTrendingSongs() {
            console.log('Fetching trending songs from API...');
            try {
                const response = await fetch('https://saavn.dev/api/search/songs?query=trending bollywood 2024');
                const data = await response.json();
                
                if (data.success && data.data.results) {
                    trendingSongs = data.data.results.slice(0, 8);
                    localStorage.setItem('trendingSongs', JSON.stringify(trendingSongs));
                    localStorage.setItem('lastTrendingUpdate', Date.now().toString());
                    console.log('Fetched trending songs:', trendingSongs.length);
                    renderTrendingSongs();
                } else {
                    throw new Error('API response unsuccessful');
                }
            } catch (error) {
                console.error('Error loading trending songs:', error);
                renderFallbackTrending();
            }
        }

        function renderFallbackTrending() {
            console.log('Using fallback trending songs...');
            trendingSongs = getFallbackSongs();
            renderTrendingSongs();
        }

        function renderTrendingSongs() {
            console.log('Rendering trending songs...');
            const container = document.getElementById('trending-container');
            if (!container) {
                console.error('Trending container not found!');
                return;
            }
            
            container.innerHTML = '';

            const songsToShow = trendingSongs.length > 0 ? trendingSongs : getFallbackSongs();
            console.log('Songs to show:', songsToShow.length);

            // Add at least 12 songs to ensure horizontal scrolling
            const minSongsToShow = songsToShow.length >= 12 ? songsToShow : [...songsToShow, ...getFallbackSongs()].slice(0, 12);

            minSongsToShow.forEach((song, index) => {
                const imageUrl = song.image?.find(img => img.quality === '500x500')?.url || 
                       song.image?.[0]?.url || 
                       song.fallbackImage ||
                       'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=200&h=120&fit=crop';

                const songCard = document.createElement('div');
                songCard.className = 'trending-song';
                songCard.innerHTML = `
                    <img src="${imageUrl}" alt="Trending Music" />
                    <div class="play-icon">
                        <i class="fas fa-play"></i>
                    </div>
                `;
                songCard.onclick = () => playTrendingSong(index);
                container.appendChild(songCard);
            });

            console.log('Trending songs rendered:', container.children.length);

            // Force the scrollbar to appear by ensuring enough content
            if (minSongsToShow.length < 6) {
                // Add some empty space to ensure scrolling is needed
                const spacer = document.createElement('div');
                spacer.style.minWidth = '100px';
                spacer.style.height = '1px';
                container.appendChild(spacer);
            }
        }

        function getFallbackSongs() {
            return [
                { title: "Midnight Moods", artist: "Various Artists", fallbackImage: "https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/95b52c32-f5da-4fe6-956d-a5ed118bbdd2" },
                { title: "Party Starters", artist: "DJ Mix", fallbackImage: "https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/6ddf81f5-2689-4f34-bf80-a1e07f14621c" },
                { title: "Relaxing Tones", artist: "Chill Vibes", fallbackImage: "https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/ab52d9d0-308e-43e0-a577-dce35fedd2a3" },
                { title: "Smooth Jazz Journey", artist: "Jazz Collective", fallbackImage: "https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/20c8fdd5-9f4a-4917-ae90-0239a52e8334" },
                { title: "Uplifting Rhythms", artist: "Feel Good", fallbackImage: "https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/df461a99-2fb3-4d55-ac16-2e0c6dd783e1" },
                { title: "Electronic Vibes", artist: "Synth Wave", fallbackImage: "https://images.unsplash.com/photo-1571974599782-87624638275c?w=200&h=120&fit=crop" }
            ];
        }

        async function playTrendingSong(index) {
            console.log('Playing trending song:', index);
            const song = trendingSongs[index] || getFallbackSongs()[index];
            if (!song) {
                console.error('Song not found at index:', index);
                return;
            }

            if (song.downloadUrl) {
                // Real JioSaavn song
                const downloadUrl = song.downloadUrl?.find(dl => dl.quality === '320kbps')?.url ||
                                   song.downloadUrl?.[song.downloadUrl.length - 1]?.url;
                
                if (!downloadUrl) {
                    alert('No download URL found for this song.');
                    return;
                }

                try {
                    audioPlayer.src = downloadUrl;
                    await audioPlayer.play();
                    
                    playerTitle.textContent = song.name;
                    playerArtist.textContent = song.artists?.primary?.[0]?.name || 'Unknown Artist';
                    
                    const imageUrl = song.image?.find(img => img.quality === '500x500')?.url || 
                                   song.image?.[0]?.url || 
                                   'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=200&h=200&fit=crop';
                    playerAlbumArt.src = imageUrl;
                    
                    playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    isPlaying = true;
                    isOnlineSong = true;
                    currentSongIndex = -1;

                    // FIXED: Fetch lyrics for trending songs
                    fetchLyrics(song.name, song.artists?.primary?.[0]?.name || 'Unknown Artist');

                    // Add to history and recent artists/albums
                    const historyItem = {
                        id: 'trending_' + song.id,
                        title: song.name,
                        artist: song.artists?.primary?.[0]?.name || 'Unknown Artist',
                        album: song.album?.name || 'Online',
                        albumArt: imageUrl,
                        isOnline: true,
                        downloadUrl: downloadUrl
                    };
                    addToHistory(historyItem);
                    addToRecentArtists(historyItem.artist, imageUrl);
                    addToRecentAlbums(historyItem.album, imageUrl);
                    console.log('Successfully played trending song');
                } catch (error) {
                    console.error('Error playing song:', error);
                    alert('Failed to play song. This may be due to CORS restrictions.');
                }
            } else {
                // Fallback song
                alert('Demo song - Add your music library to play real songs!');
            }
        }

        // Load featured artists
        function loadFeaturedArtists() {
            const container = document.getElementById('featured-artists');
            if (!container) return;
            
            container.innerHTML = '';

            if (recentArtists.length === 0) {
                // Show default artists if no recent ones
                const defaultArtists = [
                    { name: "Taylor Swift", image: "https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=80&h=80&fit=crop&crop=face" },
                    { name: "The Weeknd", image: "https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=80&h=80&fit=crop&crop=face" },
                    { name: "Dua Lipa", image: "https://images.unsplash.com/photo-1494790108755-2616b612b786?w=80&h=80&fit=crop&crop=face" },
                    { name: "Justin", image: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=80&h=80&fit=crop&crop=face" },
                    { name: "Alicia Keys", image: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=80&h=80&fit=crop&crop=face" },
                    { name: "Maroon 5", image: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=80&h=80&fit=crop&crop=face" },
                    { name: "Imagine Dragons", image: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=80&h=80&fit=crop&crop=face" },
                    { name: "Billie Eilish", image: "https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=80&h=80&fit=crop&crop=face" }
                ];
                
                defaultArtists.forEach((artist) => {
                    const card = document.createElement('div');
                    card.className = 'artist-card';
                    card.innerHTML = `
                        <img src="${artist.image}" alt="${artist.name}" class="artist-avatar">
                        <div class="artist-name">${artist.name}</div>
                    `;
                    card.onclick = () => {
                        // Filter songs by artist and switch to songs tab
                        filterByArtist(artist.name);
                    };
                    container.appendChild(card);
                });
                return;
            }

            recentArtists.slice(0, 8).forEach((artist) => {
                const card = document.createElement('div');
                card.className = 'artist-card';
                card.innerHTML = `
                    <img src="${artist.image}" alt="${artist.name}" class="artist-avatar">
                    <div class="artist-name">${artist.name}</div>
                `;
                card.onclick = () => {
                    // Filter songs by artist and switch to songs tab
                    filterByArtist(artist.name);
                };
                container.appendChild(card);
            });
        }

        // Load recent albums
        function loadRecentAlbums() {
            const container = document.getElementById('recent-albums');
            if (!container) return;
            
            container.innerHTML = '';

            if (recentAlbums.length === 0) {
                // Show default albums if no recent ones
                const defaultAlbums = [
                    { name: "Views", artist: "Drake", image: "https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/95b52c32-f5da-4fe6-956d-a5ed118bbdd2" },
                    { name: "Speak Now", artist: "Taylor Swift", image: "https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/6ddf81f5-2689-4f34-bf80-a1e07f14621c" },
                    { name: "Born to Die", artist: "Lana Del Rey", image: "https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/ab52d9d0-308e-43e0-a577-dce35fedd2a3" },
                    { name: "Endless Summer Vacation", artist: "Miley Cyrus", image: "https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/20c8fdd5-9f4a-4917-ae90-0239a52e8334" },
                    { name: "The Dark Side Of The Moon", artist: "Pink Floyd", image: "https://github.com/ecemgo/mini-samples-great-tricks/assets/13468728/df461a99-2fb3-4d55-ac16-2e0c6dd783e1" }
                ];
                
                defaultAlbums.forEach((album) => {
                    const card = document.createElement('div');
                    card.className = 'album-card';
                    card.innerHTML = `
                        <img src="${album.image}" alt="${album.name}" class="album-cover">
                        <div class="album-info">
                            <h4>${album.name}</h4>
                            <p>${album.artist}</p>
                        </div>
                    `;
                    card.onclick = () => {
                        // If album is online, search JioSaavn and show in online tab
                        if (album.isOnline) {
                            document.querySelector('.tab[data-tab="online"]').click();
                            onlineSearch.value = album.name;
                            onlineSearch.dispatchEvent(new Event('input'));
                        } else {
                            // Filter songs by album and switch to songs tab
                            filterByAlbum(album.name);
                        }
                    };
                    container.appendChild(card);
                });
                return;
            }

            recentAlbums.slice(0, 10).forEach((album) => {
                const card = document.createElement('div');
                card.className = 'album-card';
                card.innerHTML = `
                    <img src="${album.image}" alt="${album.name}" class="album-cover">
                    <div class="album-info">
                        <h4>${album.name}</h4>
                        <p>Album</p>
                    </div>
                `;
                card.onclick = () => {
                    // If album is online, search JioSaavn and show in online tab
                    if (album.isOnline) {
                        document.querySelector('.tab[data-tab="online"]').click();
                        onlineSearch.value = album.name;
                        onlineSearch.dispatchEvent(new Event('input'));
                    } else {
                        // Filter songs by album and switch to songs tab
                        filterByAlbum(album.name);
                    }
                };
                container.appendChild(card);
            });
        }

        // New function to filter by artist with proper UI feedback
        function filterByArtist(artistName) {
            // Check if we have local songs with this artist
            const localSongs = songs.filter(s => 
                s.artist.toLowerCase().includes(artistName.toLowerCase())
            );
            if (localSongs.length > 0) {
                activeFilter = artistName;
                filterText.textContent = `Artist: ${artistName}`;
                filterIndicator.style.display = 'inline-block';
                search.value = '';
                updateSongList(artistName);
                document.querySelector('.tab[data-tab="songs"]').click();
            } else {
                document.querySelector('.tab[data-tab="online"]').click();
                onlineSearch.value = artistName;
                onlineSearch.dispatchEvent(new Event('input'));
            }
        }

        // New function to filter by album with proper UI feedback
        function filterByAlbum(albumName) {
            const isOnlineAlbum = recentAlbums.find(a => a.name === albumName && a.isOnline);
            if (isOnlineAlbum) {
                document.querySelector('.tab[data-tab="online"]').click();
                onlineSearch.value = albumName;
                onlineSearch.dispatchEvent(new Event('input'));
                return;
            }
            const localSongs = songs.filter(s => 
                s.album.toLowerCase().includes(albumName.toLowerCase())
            );
            if (localSongs.length > 0) {
                activeFilter = albumName;
                filterText.textContent = `Album: ${albumName}`;
                filterIndicator.style.display = 'inline-block';
                search.value = '';
                updateSongList(albumName);
                document.querySelector('.tab[data-tab="songs"]').click();
            } else {
                document.querySelector('.tab[data-tab="online"]').click();
                onlineSearch.value = albumName;
                onlineSearch.dispatchEvent(new Event('input'));
            }
        }

        // Load recently played
        function loadRecentlyPlayed() {
            const container = document.getElementById('recently-played');
            if (!container) return;
            
            container.innerHTML = '';

            if (history.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center;">No recent plays</p>';
                return;
            }

            history.slice(0, 8).forEach((song, index) => {
                const item = document.createElement('div');
                item.className = 'recent-item';
                item.innerHTML = `
                    <img src="${song.albumArt || 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=50&h=50&fit=crop'}" alt="${song.title}">
                    <div class="recent-info">
                        <h4>${song.title}</h4>
                        <p>${song.artist}</p>
                    </div>
                    <button class="delete-btn" onclick="removeFromHistory(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                item.onclick = (e) => {
                    if (!e.target.closest('.delete-btn')) {
                        playSongFromHistory(song);
                    }
                };
                container.appendChild(item);
            });
        }

        function addToHistory(song) {
            history = history.filter(s => s.id !== song.id);
            history.unshift(song);
            if (history.length > 50) history.pop();
            localStorage.setItem('musicAppHistory', JSON.stringify(history));
            loadRecentlyPlayed();
            updateHistoryList();
        }

        function addToRecentArtists(artistName, image) {
            if (!artistName || artistName === 'Unknown Artist') return;
            
            recentArtists = recentArtists.filter(a => a.name !== artistName);
            recentArtists.unshift({ name: artistName, image });
            if (recentArtists.length > 20) recentArtists.pop();
            localStorage.setItem('recentArtists', JSON.stringify(recentArtists));
            loadFeaturedArtists();
        }

        function addToRecentAlbums(albumName, image, isOnline = false) {
            if (!albumName || albumName === 'Unknown Album' || albumName === 'Online') return;
            
            recentAlbums = recentAlbums.filter(a => a.name !== albumName);
            recentAlbums.unshift({ name: albumName, image, isOnline });
            if (recentAlbums.length > 20) recentAlbums.pop();
            localStorage.setItem('recentAlbums', JSON.stringify(recentAlbums));
            loadRecentAlbums();
        }

        function removeFromHistory(index) {
            console.log('Removing from history:', index);
            history.splice(index, 1);
            localStorage.setItem('musicAppHistory', JSON.stringify(history));
            loadRecentlyPlayed();
            updateHistoryList();
        }

        // FIXED: Enhanced playSongFromHistory function with lyrics
        async function playSongFromHistory(song) {
            console.log('Playing song from history:', song);
            
            if (song.isOnline || song.id.startsWith('online_') || song.id.startsWith('trending_')) {
                // Online song
                if (song.downloadUrl) {
                    // Direct play with stored download URL
                    try {
                        audioPlayer.src = song.downloadUrl;
                        await audioPlayer.play();
                        
                        playerTitle.textContent = song.title;
                        playerArtist.textContent = song.artist;
                        playerAlbumArt.src = song.albumArt;
                        
                        playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        isPlaying = true;
                        isOnlineSong = true;
                        currentSongIndex = -1;

                        // FIXED: Fetch lyrics for history songs
                        fetchLyrics(song.title, song.artist);
                        
                        console.log('Successfully played online song from history');
                    } catch (error) {
                        console.error('Error playing online song from history:', error);
                        alert('Failed to play song. The link may have expired.');
                    }
                } else {
                    // Try to find in current online songs
                    const songId = song.id.replace('trending_', '').replace('online_', '');
                    const onlineSong = onlineSongs.find(s => s.id === songId);
                    if (onlineSong) {
                        playOnlineSong(onlineSong);
                    } else {
                        // If it's an online album, search for it
                        if (song.album && song.album !== 'Online') {
                            document.querySelector('.tab[data-tab="online"]').click();
                            onlineSearch.value = song.album;
                            onlineSearch.dispatchEvent(new Event('input'));
                        } else {
                            alert('Online song not available. Please search for it again.');
                        }
                    }
                }
            } else {
                // Local song
                const songIndex = songs.findIndex(s => s.id === song.id);
                if (songIndex !== -1) {
                    playSong(songIndex);
                } else {
                    alert('Song file not found. Please re-upload your music library.');
                }
            }
        }

        // Initialize home page content when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            loadTrendingSongs();
            loadRecentlyPlayed();
            loadFeaturedArtists();
            loadRecentAlbums();
        });

        // Set up automatic trending refresh every 3 hours
        setInterval(loadTrendingSongs, 3 * 60 * 60 * 1000);

        // Your existing JavaScript code continues here...
        const DB_NAME = 'MusicAppDB';
        const STORE_NAME = 'directoryHandle';
        async function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function saveDirectoryHandle(handle) {
            try {
                const db = await openDB();
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                await new Promise((resolve, reject) => {
                    const request = store.put({ id: 'directory', handle });
                    request.onsuccess = resolve;
                    request.onerror = () => reject(request.error);
                });
                console.log('Directory handle saved');
            } catch (err) {
                console.error('Error saving directory handle:', err);
            }
        }

        async function getDirectoryHandle() {
            try {
                const db = await openDB();
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get('directory');
                return await new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve(request.result?.handle);
                    request.onerror = () => reject(request.error);
                });
            } catch (err) {
                console.error('Error retrieving directory handle:', err);
                return null;
            }
        }

        async function loadFromLocalStorage() {
            console.log('Loading from localStorage');
            const savedSongs = localStorage.getItem('musicAppSongs');
            if (savedSongs) {
                songs = JSON.parse(savedSongs).map(song => ({
                    ...song,
                    file: null
                }));
                console.log('Saved songs loaded:', songs.length);
                if (songs.length > 0 && window.showDirectoryPicker) {
                    console.log('Attempting to access saved directory');
                    try {
                        const handle = await getDirectoryHandle();
                        if (handle) {
                            console.log('Directory handle found, requesting permission');
                            const permission = await handle.requestPermission({ mode: 'read' });
                            if (permission === 'granted') {
                                console.log('Permission granted, loading files');
                                await loadFilesFromDirectory(handle);
                            } else {
                                console.log('Permission denied');
                                alert('Permission to access music folder was denied. Please select the folder manually.');
                                folderInput.click();
                            }
                        } else {
                            console.log('No directory handle found');
                            alert('No previous music folder found. Please select a folder.');
                            folderInput.click();
                        }
                    } catch (err) {
                        console.error('Error accessing directory:', err);
                        alert('Failed to access music folder. Please select the folder manually.');
                        folderInput.click();
                    }
                } else {
                    console.log('API unsupported or no songs, using fallback');
                    if (songs.length > 0) {
                        alert('Please select the music folder to load your songs.');
                        folderInput.click();
                    }
                }
            }
            const savedPlaylists = localStorage.getItem('musicAppPlaylists');
            if (savedPlaylists) {
                playlists = JSON.parse(savedPlaylists);
            }
            const savedFavorites = localStorage.getItem('musicAppFavorites');
            if (savedFavorites) {
                favorites = JSON.parse(savedFavorites);
            }
            const savedSettings = localStorage.getItem('musicAppSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                isShuffling = settings.isShuffling || false;
                isRepeating = settings.isRepeating || false;
                volumeSlider.value = settings.volume || 100;
                audioPlayer.volume = settings.volume / 100 || 1;
                shuffleBtn.style.opacity = isShuffling ? '1' : '0.8';
                shuffleBtn.style.color = isShuffling ? 'var(--primary)' : 'var(--text)';
                repeatBtn.style.opacity = isRepeating ? '1' : '0.8';
                repeatBtn.style.color = isRepeating ? 'var(--primary)' : 'var(--text)';
            }
            updateSongList();
            updateArtistList();
            updateAlbumList();
            updatePlaylistList();
            updateFavoritesList();
            updateHistoryList();
        }

        function saveToLocalStorage() {
            localStorage.setItem('musicAppSongs', JSON.stringify(songs.map(song => ({
                id: song.id,
                title: song.title,
                artist: song.artist,
                album: song.album,
                albumArt: song.albumArt,
                fileName: song.file ? song.file.name : song.fileName
            }))));
            localStorage.setItem('musicAppPlaylists', JSON.stringify(playlists));
            localStorage.setItem('musicAppFavorites', JSON.stringify(favorites));
            localStorage.setItem('musicAppSettings', JSON.stringify({
                isShuffling,
                isRepeating,
                volume: volumeSlider.value
            }));
        }

        async function loadFilesFromDirectory(directoryHandle) {
            loading.style.display = 'block';
            error.style.display = 'none';
            songList.innerHTML = '';
            console.log('Loading files from directory');

            const validFiles = [];
            try {
                for await (const entry of directoryHandle.values()) {
                    if (entry.kind === 'file' && await validateFile(entry)) {
                        const file = await entry.getFile();
                        validFiles.push(file);
                    }
                }
            } catch (err) {
                console.error('Error reading directory:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'Failed to read music folder. Please select the folder manually.';
                folderInput.click();
                return;
            }

            if (validFiles.length === 0) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'No supported audio files found in the directory.';
                return;
            }

            const newSongs = [];
            for (const file of validFiles) {
                const existingSong = songs.find(song => song.fileName === file.name);
                if (existingSong) {
                    existingSong.file = file;
                    existingSong.title = existingSong.title || file.name;
                    existingSong.artist = existingSong.artist || 'Unknown Artist';
                    existingSong.album = existingSong.album || 'Unknown Album';
                    existingSong.albumArt = existingSong.albumArt || placeholderCover;
                    newSongs.push(existingSong);
                } else {
                    const metadata = await readMetadata(file);
                    newSongs.push({
                        id: songs.length + newSongs.length + 1,
                        file,
                        title: metadata.title || file.name,
                        artist: metadata.artist || 'Unknown Artist',
                        album: metadata.album || 'Unknown Album',
                        albumArt: metadata.picture || placeholderCover,
                        fileName: file.name
                    });
                }
            }
            songs = newSongs;

            loading.style.display = 'none';
            updateSongList();
            updateArtistList();
            updateAlbumList();
            updateFavoritesList();
            updateHistoryList();
            saveToLocalStorage();
            console.log('Library reloaded with', songs.length, 'songs');
        }

        loadFromLocalStorage();

        const placeholderCover = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="%23708090"%3E%3Crect width="100" height="100" rx="8"/%3E%3Cpath d="M30 70V30l40 20-40 20z" fill="%23A0B0C0"/%3E%3C/svg%3E';

        const supportedFormats = [
            { mime: 'audio/mpeg', ext: '.mp3' },
            { mime: 'audio/wav', ext: '.wav' },
            { mime: 'audio/ogg', ext: '.ogg' },
            { mime: 'audio/mp4', ext: '.m4a' }
        ];

        function canPlayFormat(mime) {
            const audio = document.createElement('audio');
            return audio.canPlayType(mime) === 'probably' || audio.canPlayType(mime) === 'maybe';
        }

        async function validateFile(file) {
            const ext = (file.name || file).toLowerCase().slice((file.name || file).lastIndexOf('.'));
            const format = supportedFormats.find(f => f.ext === ext && canPlayFormat(f.mime));
            if (!format) return false;

            const fileObj = file.getFile ? await file.getFile() : file;
            const url = URL.createObjectURL(fileObj);
            const audio = new Audio(url);
            return new Promise((resolve) => {
                audio.onloadedmetadata = () => {
                    URL.revokeObjectURL(url);
                    resolve(true);
                };
                audio.onerror = () => {
                    URL.revokeObjectURL(url);
                    resolve(false);
                };
            });
        }

        function cleanName(name) {
            return name
                .replace(/\$.*?\$/g, '')
                .replace(/feat\.|ft\.|with\s/i, '')
                .replace(/[^a-zA-Z0-9\s]/g, '')
                .trim();
        }

        // FIXED: Clear filters when switching to "All Songs" tab
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                
                // FIXED: Clear search filter when switching to All Songs
                if (tab.dataset.tab === 'songs') {
                    // If we're not applying a specific filter, clear all filters
                    if (!activeFilter) {
                        search.value = ''; // Clear search input
                        filterIndicator.style.display = 'none';
                        updateSongList(); // Show all songs without filter
                    }
                } else if (tab.dataset.tab === 'artists') {
                    search.value = '';
                    updateArtistList();
                } else if (tab.dataset.tab === 'albums') {
                    search.value = '';
                    updateAlbumList();
                } else if (tab.dataset.tab === 'lyrics') {
                    lyricsInputContainer.classList.remove('active');
                    typeLyricsBtn.style.display = 'block';
                    lyrics.style.display = 'block';
                    lyricsLoading.style.display = currentLyrics.length ? 'none' : 'block';
                    lyricsError.style.display = currentLyrics.length ? 'none' : 'block';
                } else if (tab.dataset.tab === 'online') {
                    onlineSearch.focus();
                } else if (tab.dataset.tab === 'home') {
                    loadRecentlyPlayed();
                    loadFeaturedArtists();
                    loadRecentAlbums();
                }
            });
        });

        async function selectDirectory() {
            console.log('Selecting directory');
            if (window.showDirectoryPicker) {
                try {
                    const directoryHandle = await window.showDirectoryPicker();
                    await saveDirectoryHandle(directoryHandle);
                    await loadFilesFromDirectory(directoryHandle);
                } catch (err) {
                    console.error('Directory selection error:', err);
                    alert('Failed to select directory. Please try again or use manual upload.');
                    folderInput.click();
                }
            } else {
                console.log('File System Access API not supported, using file input');
                folderInput.click();
            }
        }

        folderInput.addEventListener('change', async (e) => {
            loading.style.display = 'block';
            error.style.display = 'none';
            songList.innerHTML = '';
            console.log('Processing file input');

            const files = Array.from(e.target.files);
            const validFiles = [];

            for (const file of files) {
                if (await validateFile(file)) {
                    validFiles.push(file);
                }
            }

            if (validFiles.length === 0) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'No supported audio files found.';
                return;
            }

            // Visual indicator: show checkmark animation
            loading.style.display = 'none';
            const indicator = document.createElement('div');
            indicator.style.position = 'fixed';
            indicator.style.top = '50%';
            indicator.style.left = '50%';
            indicator.style.transform = 'translate(-50%, -50%)';
            indicator.style.background = 'rgba(40,40,40,0.95)';
            indicator.style.color = '#7bff68';
            indicator.style.fontSize = '48px';
            indicator.style.borderRadius = '50%';
            indicator.style.padding = '40px';
            indicator.style.zIndex = '9999';
            indicator.innerHTML = '<i class="fas fa-check-circle"></i> Songs Added!';
            document.body.appendChild(indicator);
            setTimeout(() => {
                indicator.remove();
            }, 1200);

            const newSongs = [];
            for (const file of validFiles) {
                const existingSong = songs.find(song => song.fileName === file.name);
                if (existingSong) {
                    existingSong.file = file;
                    existingSong.title = existingSong.title || file.name;
                    existingSong.artist = existingSong.artist || 'Unknown Artist';
                    existingSong.album = existingSong.album || 'Unknown Album';
                    existingSong.albumArt = existingSong.albumArt || placeholderCover;
                    newSongs.push(existingSong);
                } else {
                    const metadata = await readMetadata(file);
                    newSongs.push({
                        id: songs.length + newSongs.length + 1,
                        file,
                        title: metadata.title || file.name,
                        artist: metadata.artist || 'Unknown Artist',
                        album: metadata.album || 'Unknown Album',
                        albumArt: metadata.picture || placeholderCover,
                        fileName: file.name
                    });
                }
            }
            songs = newSongs;
            updateSongList();
            updateArtistList();
            updateAlbumList();
            updateFavoritesList();
            updateHistoryList();
            saveToLocalStorage();
            console.log('Library updated with', songs.length, 'songs');
        });

        function readMetadata(file) {
            return new Promise((resolve) => {
                jsmediatags.read(file, {
                    onSuccess: (tag) => {
                        const picture = tag.tags.picture || tag.tags['covr'];
                        let cover = null;
                        if (picture) {
                            const base64String = btoa(
                                picture.data.reduce((data, byte) => data + String.fromCharCode(byte), '')
                            );
                            cover = `data:${picture.format || 'image/jpeg'};base64,${base64String}`;
                        }
                        resolve({
                            title: tag.tags.title || file.name,
                            artist: tag.tags.artist || 'Unknown Artist',
                            album: tag.tags.album || 'Unknown Album',
                            picture: cover
                        });
                    },
                    onError: () => resolve({
                        title: file.name,
                        artist: 'Unknown Artist',
                        album: 'Unknown Album',
                        picture: null
                    })
                });
            });
        }

        function updateSongList(filter = '') {
            songList.innerHTML = '';
            
            // If active filter is set, use that instead of the parameter
            const activeFilterText = activeFilter || filter;
            
            if (activeFilterText && activeFilter) {
                filterText.textContent = activeFilter;
                filterIndicator.style.display = 'inline-block';
            } else if (filter && !activeFilter) {
                filterIndicator.style.display = 'none';
            }
            
            const filteredSongs = songs.filter(song =>
                song.title.toLowerCase().includes(activeFilterText.toLowerCase()) ||
                song.artist.toLowerCase().includes(activeFilterText.toLowerCase()) ||
                song.album.toLowerCase().includes(activeFilterText.toLowerCase())
            );
            
            filteredSongs.forEach(song => {
                const card = document.createElement('div');
                card.className = 'music-card';
                card.dataset.id = song.id;
                card.innerHTML = `
                    <img src="${song.albumArt}" alt="Album Cover">
                    <div class="music-info">
                        <h3>${song.title}</h3>
                        <p>${song.artist}</p>
                    </div>
                    <button class="add-to-playlist" onclick="addToPlaylistPrompt(${song.id})" title="Add to Playlist">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.add-to-playlist')) {
                        isOnlineSong = false;
                        playSong(songs.findIndex(s => s.id === song.id));
                    }
                });
                songList.appendChild(card);
            });
        }

        function updateArtistList(filter = '') {
            artistList.innerHTML = '';
            const artists = [...new Set(songs.map(song => song.artist))].filter(artist =>
                artist.toLowerCase().includes(filter.toLowerCase())
            );
            artists.forEach(artist => {
                const card = document.createElement('div');
                card.className = 'music-card';
                const songCount = songs.filter(song => song.artist === artist).length;
                const firstSong = songs.find(song => song.artist === artist);
                card.innerHTML = `
                    <img src="${firstSong.albumArt}" alt="Artist">
                    <div class="music-info">
                        <h3>${artist}</h3>
                        <p>${songCount} songs</p>
                    </div>
                `;
                card.addEventListener('click', () => {
                    filterByArtist(artist);
                });
                artistList.appendChild(card);
            });
        }

        function updateAlbumList(filter = '') {
            albumList.innerHTML = '';
            const albums = [...new Set(songs.map(song => song.album))].filter(album =>
                album.toLowerCase().includes(filter.toLowerCase())
            );
            albums.forEach(album => {
                const card = document.createElement('div');
                card.className = 'music-card';
                const firstSong = songs.find(song => song.album === album);
                card.innerHTML = `
                    <img src="${firstSong.albumArt}" alt="Album">
                    <div class="music-info">
                        <h3>${album}</h3>
                        <p>${firstSong.artist}</p>
                    </div>
                `;
                card.addEventListener('click', () => {
                    filterByAlbum(album);
                });
                albumList.appendChild(card);
            });
        }

        function updatePlaylistList(filter = '') {
            playlistList.innerHTML = '';
            const filteredPlaylists = playlists.filter(playlist =>
                playlist.name.toLowerCase().includes(filter.toLowerCase())
            );
            filteredPlaylists.forEach((playlist, index) => {
                const card = document.createElement('div');
                card.className = 'music-card';
                const cover = playlist.songs[0]?.albumArt || placeholderCover;
                card.innerHTML = `
                    <img src="${cover}" alt="Playlist">
                    <div class="music-info">
                        <h3>${playlist.name}</h3>
                        <p>${playlist.songs.length} songs</p>
                    </div>
                    <button class="add-to-playlist" onclick="deletePlaylist(${index})" title="Delete Playlist">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.add-to-playlist')) {
                        playPlaylist(index);
                    }
                });
                playlistList.appendChild(card);
            });
        }

        function updateFavoritesList(filter = '') {
            favoritesList.innerHTML = '';
            const filteredFavorites = favorites.filter(song =>
                song.title.toLowerCase().includes(filter.toLowerCase()) ||
                song.artist.toLowerCase().includes(filter.toLowerCase()) ||
                song.album.toLowerCase().includes(filter.toLowerCase())
            );
            filteredFavorites.forEach(song => {
                const card = document.createElement('div');
                card.className = 'music-card';
                card.dataset.id = song.id;
                card.innerHTML = `
                    <img src="${song.albumArt}" alt="Favorite">
                    <div class="music-info">
                        <h3>${song.title}</h3>
                        <p>${song.artist}</p>
                    </div>
                    <button class="add-to-playlist" onclick="addToPlaylistPrompt(${song.id})" title="Add to Playlist">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.add-to-playlist')) {
                        isOnlineSong = false;
                        playSong(songs.findIndex(s => s.id === song.id));
                    }
                });
                favoritesList.appendChild(card);
            });
        }

        function updateOnlineList(songs = []) {
            onlineList.innerHTML = '';
            songs.forEach(song => {
                const card = document.createElement('div');
                card.className = 'music-card';
                card.dataset.songId = song.id;
                const imageUrl = song.image?.find(img => img.quality === '500x500')?.url || song.image?.[0]?.url || placeholderCover;
                const artistName = song.artists?.primary?.[0]?.name || 'Unknown Artist';
                card.innerHTML = `
                    <img src="${imageUrl}" alt="Album Art">
                    <div class="music-info">
                        <h3>${song.name}</h3>
                        <p>${artistName}</p>
                    </div>
                    <button class="add-to-playlist" onclick="addOnlineToPlaylistPrompt('${song.id}')" title="Add to Playlist">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="add-to-playlist download-online" data-songid="${song.id}" title="Download Song">
                        <i class="fas fa-download"></i>
                    </button>
                `;
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.add-to-playlist')) {
                        playOnlineSong(song);
                    }
                });
                onlineList.appendChild(card);
            });
            // Attach download event
            onlineList.querySelectorAll('.download-online').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const songId = btn.dataset.songid;
                    const song = onlineSongs.find(s => s.id === songId);
                    if (!song) return;
                    const downloadUrl = song.downloadUrl?.find(dl => dl.quality === '320kbps')?.url || song.downloadUrl?.[song.downloadUrl.length - 1]?.url;
                    if (!downloadUrl) {
                        alert('No download URL found for this song.');
                        return;
                    }
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `${song.name}.mp3`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });
            });
        }

        search.addEventListener('input', (e) => {
            const filter = e.target.value;
            // Clear active filter when user types in search
            if (filter) {
                activeFilter = '';
                filterIndicator.style.display = 'none';
            }
            updateSongList(filter);
            updateArtistList(filter);
            updateAlbumList(filter);
            updatePlaylistList(filter);
            updateFavoritesList(filter);
            updateHistoryList(filter);
        });

        onlineSearch.addEventListener('input', async (e) => {
            const query = e.target.value.trim();
            if (query.length < 3) {
                onlineList.innerHTML = '';
                onlineLoading.style.display = 'none';
                onlineError.style.display = 'none';
                return;
            }
            onlineLoading.style.display = 'block';
            onlineError.style.display = 'none';
            try {
                const response = await fetch(`https://saavn.dev/api/search/songs?query=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                const data = await response.json();
                if (data.success) {
                    onlineSongs = data.data.results;
                    updateOnlineList(onlineSongs);
                } else {
                    throw new Error('API returned unsuccessful response');
                }
                onlineLoading.style.display = 'none';
            } catch (err) {
                console.error('JioSaavn search error:', err);
                onlineLoading.style.display = 'none';
                onlineError.style.display = 'block';
                onlineError.textContent = `Failed to search JioSaavn: ${err.message}`;
            }
        });

        async function playSong(index) {
            if (index < 0 || index >= songs.length) return;
            const song = songs[index];
            if (!song.file) {
                alert('Please re-upload the music files to play this song.');
                selectDirectory();
                return;
            }
            isOnlineSong = false;
            currentSongIndex = index;
            currentVideoId = null;
            youtubePlayer.src = '';
            const url = URL.createObjectURL(song.file);
            audioPlayer.src = url;

            try {
                await audioPlayer.play();
                playerTitle.textContent = song.title;
                playerArtist.textContent = song.artist;
                playerAlbumArt.src = song.albumArt;
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                isPlaying = true;
                likeBtn.classList.toggle('liked', favorites.some(f => f.id === song.id));
                fetchLyrics(song.title, song.artist);
                const historyItem = {
                    id: song.id,
                    title: song.title,
                    artist: song.artist,
                    album: song.album,
                    albumArt: song.albumArt,
                    isOnline: false
                };
                addToHistory(historyItem);
                addToRecentArtists(song.artist, song.albumArt);
                addToRecentAlbums(song.album, song.albumArt, false);
            } catch (err) {
                console.error('Playback error:', err);
                alert(`Failed to play "${song.title}": ${err.message}`);
                URL.revokeObjectURL(url);
                playNext();
            }
        }

        async function playOnlineSong(song) {
            currentOnlinePlaylist = [...onlineSongs];
            currentOnlineSongIndex = currentOnlinePlaylist.findIndex(s => s.id === song.id);
            currentSongIndex = -1;
            currentVideoId = null;
            youtubePlayer.src = '';
            const downloadUrl = song.downloadUrl?.find(dl => dl.quality === '320kbps')?.url ||
                               song.downloadUrl?.[song.downloadUrl.length - 1]?.url;
            if (!downloadUrl) {
                alert('No download URL found for this song.');
                return;
            }
            audioPlayer.src = downloadUrl;
            try {
                await audioPlayer.play();
                playerTitle.textContent = song.name;
                playerArtist.textContent = song.artists?.primary?.[0]?.name || 'Unknown Artist';
                const imageUrl = song.image?.find(img => img.quality === '500x500')?.url || song.image?.[0]?.url || placeholderCover;
                playerAlbumArt.src = imageUrl;
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                isPlaying = true;
                likeBtn.classList.remove('liked');
                fetchLyrics(song.name, song.artists?.primary?.[0]?.name || 'Unknown Artist');
                const historyItem = {
                    id: 'online_' + song.id,
                    title: song.name,
                    artist: song.artists?.primary?.[0]?.name || 'Unknown Artist',
                    album: song.album?.name || 'Online',
                    albumArt: imageUrl,
                    fileName: song.id,
                    isOnline: true,
                    downloadUrl: downloadUrl
                };
                addToHistory(historyItem);
                addToRecentArtists(historyItem.artist, imageUrl);
                addToRecentAlbums(historyItem.album, imageUrl, true);
            } catch (err) {
                console.error('Online playback error:', err);
                alert(`Failed to play "${song.name}": ${err.message}. This may be due to CORS or unsupported format. Try downloading the song instead.`);
            }
        }

        async function fetchLyrics(title, artist, retries = 2) {
            lyricsLoading.style.display = 'block';
            lyricsError.style.display = 'none';
            lyrics.innerHTML = '';
            lyricsInputContainer.classList.remove('active');
            typeLyricsBtn.style.display = 'block';
            lyrics.style.display = 'block';

            const queries = [
                { title, artist },
                { title: cleanName(title), artist: cleanName(artist) },
                { title: title.split('-')[0].trim(), artist }
            ];

            for (let i = 0; i < queries.length && retries >= 0; i++) {
                const { title: qTitle, artist: qArtist } = queries[i];
                try {
                    const response = await fetch(`https://lrclib.net/api/get?artist_name=${encodeURIComponent(qArtist)}&track_name=${encodeURIComponent(qTitle)}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    if (data.syncedLyrics) {
                        currentLyrics = parseLRCLyrics(data.syncedLyrics);
                        updateLyrics();
                        lyricsLoading.style.display = 'none';
                        return;
                    } else if (data.plainLyrics) {
                        currentLyrics = [{ time: 0, text: data.plainLyrics }];
                        lyrics.innerHTML = `<div class="lyrics-line">${data.plainLyrics.replace(/\n/g, '<br>')}</div>`;
                        lyricsLoading.style.display = 'none';
                        return;
                    }
                } catch (error) {
                    console.error(`Lyrics fetch error (title: ${qTitle}, artist: ${qArtist}):`, error);
                    if (i === queries.length - 1 && retries > 0) {
                        retries--;
                        i = -1;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }

            lyricsLoading.style.display = 'none';
            lyricsError.style.display = 'block';
            lyricsError.textContent = 'No lyrics found for this song.';
        }

        function parseLRCLyrics(lrc) {
            const lines = lrc.split('\n');
            const lyrics = [];
            const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
            for (const line of lines) {
                const match = line.match(timeRegex);
                if (match) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    const milliseconds = parseInt(match[3].padEnd(3, '0'));
                    const time = minutes * 60 + seconds + milliseconds / 1000;
                    const text = line.replace(timeRegex, '').trim();
                    if (text) {
                        lyrics.push({ time, text });
                    }
                }
            }
            return lyrics;
        }

        function updateLyrics() {
            const currentTime = audioPlayer.currentTime;
            let activeIndex = -1;
            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentTime >= currentLyrics[i].time) {
                    activeIndex = i;
                } else {
                    break;
                }
            }
            lyrics.innerHTML = currentLyrics
                .map((lyric, index) => {
                    const isActive = index === activeIndex;
                    return `<div class="lyrics-line ${isActive ? 'active' : ''}">${lyric.text}</div>`;
                })
                .join('');
            if (activeIndex >= 0 && document.getElementById('lyrics-tab').classList.contains('active')) {
                const activeLine = lyrics.children[activeIndex];
                if (activeLine) {
                    activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function toggleLyricsInput() {
            const isInputVisible = lyricsInputContainer.classList.contains('active');
            lyricsInputContainer.classList.toggle('active', !isInputVisible);
            typeLyricsBtn.style.display = isInputVisible ? 'block' : 'none';
            lyrics.style.display = isInputVisible ? 'block' : 'none';
            lyricsLoading.style.display = 'none';
            lyricsError.style.display = 'none';
            if (!isInputVisible) {
                lyricsInput.value = '';
                lyricsInput.focus();
            }
        }

        function saveLyrics() {
            const text = lyricsInput.value.trim();
            if (!text) {
                lyricsError.style.display = 'block';
                lyricsError.textContent = 'Please enter some lyrics.';
                return;
            }
            lyricsInputContainer.classList.remove('active');
            typeLyricsBtn.style.display = 'block';
            lyrics.style.display = 'block';
            lyricsError.style.display = 'none';
            currentLyrics = [{ time: 0, text: text }];
            lyrics.innerHTML = `<div class="lyrics-line">${text.replace(/\n/g, '<br>')}</div>`;
        }

        typeLyricsBtn.addEventListener('click', toggleLyricsInput);
        saveLyricsBtn.addEventListener('click', saveLyrics);

        likeBtn.addEventListener('click', () => {
            if (currentSongIndex === -1) {
                alert('Cannot add online songs to favorites.');
                return;
            }
            const song = songs[currentSongIndex];
            if (!song) return;
            const index = favorites.findIndex(f => f.id === song.id);
            if (index === -1) {
                favorites.push(song);
                likeBtn.classList.add('liked');
            } else {
                favorites.splice(index, 1);
                likeBtn.classList.remove('liked');
            }
            updateFavoritesList();
            saveToLocalStorage();
        });

        audioPlayer.addEventListener('timeupdate', () => {
            if (!currentVideoId) {
                updateLyrics();
            }
            if (!progressBar.dragging && !currentVideoId) {
                const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100 || 0;
                progress.style.width = `${progressPercent}%`;
                currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                durationEl.textContent = formatTime(audioPlayer.duration);
                updateLyrics();
            }
        });

        audioPlayer.addEventListener('ended', () => {
            if (isRepeating && !currentVideoId) {
                if (currentSongIndex === -1) { // Online song
                    playOnlineSong(currentOnlinePlaylist[currentOnlineSongIndex]);
                } else { // Local song
                    playSong(currentSongIndex);
                }
            } else {
                playNext();
            }
        });

        audioPlayer.addEventListener('error', (e) => {
            console.error('Audio player error:', e);
            alert(`Error loading audio: ${e.message || 'Unknown error'}`);
            playNext();
        });

        playBtn.addEventListener('click', () => {
            if (isPlaying) {
                audioPlayer.pause();
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
            } else {
                audioPlayer.play().catch(err => {
                    console.error('Play error:', err);
                    alert(`Failed to play audio: ${err.message}`);
                });
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                isPlaying = true;
            }
        });

        shuffleBtn.addEventListener('click', () => {
            isShuffling = !isShuffling;
            shuffleBtn.style.opacity = isShuffling ? '1' : '0.8';
            shuffleBtn.style.color = isShuffling ? 'var(--primary)' : 'var(--text)';
            saveToLocalStorage();
        });

        repeatBtn.addEventListener('click', () => {
            isRepeating = !isRepeating;
            repeatBtn.style.opacity = isRepeating ? '1' : '0.8';
            repeatBtn.style.color = isRepeating ? 'var(--primary)' : 'var(--text)';
            saveToLocalStorage();
        });

        prevBtn.addEventListener('click', playPrev);

        nextBtn.addEventListener('click', playNext);

        volumeSlider.addEventListener('input', () => {
            audioPlayer.volume = volumeSlider.value / 100;
            saveToLocalStorage();
        });

        function playPrev() {
            if (currentSongIndex === -1) { // Online song
                if (currentOnlinePlaylist.length === 0) return;
                let prevIndex = currentOnlineSongIndex - 1;
                if (prevIndex < 0) {
                    prevIndex = currentOnlinePlaylist.length - 1;
                }
                playOnlineSong(currentOnlinePlaylist[prevIndex]);
            } else { // Local song
                let prevIndex = currentSongIndex - 1;
                if (prevIndex < 0) prevIndex = songs.length - 1;
                playSong(prevIndex);
            }
        }

        function playNext() {
            if (currentSongIndex === -1) { // Online song
                if (currentOnlinePlaylist.length === 0) return;
                let nextIndex = currentOnlineSongIndex + 1;
                if (nextIndex >= currentOnlinePlaylist.length) {
                    nextIndex = 0;
                }
                playOnlineSong(currentOnlinePlaylist[nextIndex]);
            } else { // Local song
                let nextIndex = currentSongIndex + 1;
                if (isShuffling) {
                    nextIndex = Math.floor(Math.random() * songs.length);
                } else if (nextIndex >= songs.length) {
                    nextIndex = 0;
                }
                playSong(nextIndex);
            }
        }

        function createPlaylist() {
            const name = document.getElementById('playlistName').value.trim();
            if (name) {
                playlists.push({ name, songs: [] });
                document.getElementById('playlistName').value = '';
                updatePlaylistList();
                saveToLocalStorage();
            }
        }

        function addToPlaylistPrompt(songId) {
            if (playlists.length === 0) {
                alert('Create a playlist first!');
                return;
            }
            const playlistName = prompt('Enter playlist name to add song to:');
            const playlist = playlists.find(p => p.name.toLowerCase() === playlistName?.toLowerCase());
            const song = songs.find(s => s.id === songId);
            if (playlist && song) {
                playlist.songs.push(song);
                updatePlaylistList();
                saveToLocalStorage();
            } else {
                alert('Playlist not found or invalid song!');
            }
        }

        function addOnlineToPlaylistPrompt(songId) {
            if (playlists.length === 0) {
                alert('Create a playlist first!');
                return;
            }
            const song = onlineSongs.find(s => s.id === songId);
            if (!song) return;
            const playlistName = prompt('Enter playlist name to add song to:');
            const playlist = playlists.find(p => p.name.toLowerCase() === playlistName?.toLowerCase());
            if (playlist) {
                const songToAdd = {
                    id: 'online_' + song.id,
                    title: song.name,
                    artist: song.artists?.primary?.[0]?.name || 'Unknown Artist',
                    album: song.album?.name || 'Online',
                    albumArt: song.image?.find(img => img.quality === '500x500')?.url || song.image?.[0]?.url || placeholderCover,
                    fileName: song.id
                };
                playlist.songs.push(songToAdd);
                updatePlaylistList();
                saveToLocalStorage();
            } else {
                alert('Playlist not found!');
            }
        }

        async function playPlaylist(index) {
            const playlist = playlists[index];
            if (playlist.songs.length > 0) {
                const song = playlist.songs[0];
                if (song.id.startsWith('online_')) {
                    const onlineSong = onlineSongs.find(s => s.id === song.fileName);
                    if (onlineSong) {
                        playOnlineSong(onlineSong);
                    } else {
                        alert('Online song not found. Please search again.');
                    }
                } else {
                    const songIndex = songs.findIndex(s => s.id === song.id);
                    if (songIndex !== -1) {
                        playSong(songIndex);
                    }
                }
            }
        }

        function deletePlaylist(index) {
            if (confirm(`Delete playlist "${playlists[index].name}"?`)) {
                playlists.splice(index, 1);
                updatePlaylistList();
                saveToLocalStorage();
            }
        }

        function updateHistoryList(filter = '') {
            historyList.innerHTML = '';
            const filteredHistory = history.filter(song =>
                song.title.toLowerCase().includes(filter.toLowerCase()) ||
                song.artist.toLowerCase().includes(filter.toLowerCase()) ||
                song.album.toLowerCase().includes(filter.toLowerCase())
            );
            filteredHistory.forEach((song, idx) => {
                const card = document.createElement('div');
                card.className = 'music-card';
                card.dataset.id = song.id;
                card.innerHTML = `
                    <img src="${song.albumArt}" alt="History">
                    <div class="music-info">
                        <h3>${song.title}</h3>
                        <p>${song.artist}</p>
                    </div>
                    <button class="add-to-playlist delete-history" data-index="${idx}" title="Delete from History">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.add-to-playlist')) {
                        playSongFromHistory(song);
                    }
                });
                historyList.appendChild(card);
            });
            // Attach delete event
            historyList.querySelectorAll('.delete-history').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.index);
                    history.splice(idx, 1);
                    updateHistoryList();
                    loadRecentlyPlayed();
                    localStorage.setItem('musicAppHistory', JSON.stringify(history));
                });
            });
        }

        progressBar.addEventListener('mousedown', () => {
            if (!currentVideoId) {
                progressBar.dragging = true;
            }
        });

        progressBar.addEventListener('mousemove', (e) => {
            if (progressBar.dragging && !currentVideoId) {
                const width = progressBar.clientWidth;
                const clickX = e.offsetX;
                const progressPercent = (clickX / width) * 100;
                progress.style.width = `${progressPercent}%`;
            }
        });

        progressBar.addEventListener('mouseup', (e) => {
            if (progressBar.dragging && !currentVideoId) {
                const width = progressBar.clientWidth;
                const clickX = e.offsetX;
                const duration = audioPlayer.duration;
                audioPlayer.currentTime = (clickX / width) * duration;
                progressBar.dragging = false;
            }
        });

        progressBar.addEventListener('click', (e) => {
            if (!currentVideoId) {
                const width = progressBar.clientWidth;
                const clickX = e.offsetX;
                const duration = audioPlayer.duration;
                audioPlayer.currentTime = (clickX / width) * duration;
            }
        });

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>